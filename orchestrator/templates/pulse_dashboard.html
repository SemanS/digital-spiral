<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Work Pulse</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 28px;
            color: #2c3e50;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }
        
        .btn-secondary:hover {
            background: #d5dbdb;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .metric-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 36px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-delta {
            font-size: 14px;
            font-weight: 600;
        }
        
        .metric-delta.positive {
            color: #27ae60;
        }
        
        .metric-delta.negative {
            color: #e74c3c;
        }
        
        .metric-secondary {
            font-size: 18px;
            color: #7f8c8d;
            margin-top: 10px;
        }
        
        .section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px;
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e9ecef;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-critical {
            background: #fee;
            color: #c00;
        }
        
        .badge-high {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-medium {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .jira-instances {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .instance-badge {
            padding: 8px 16px;
            background: #ecf0f1;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instance-badge:hover {
            background: #d5dbdb;
        }

        .instance-badge.active {
            background: #3498db;
            color: white;
        }

        .instance-badge .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .instance-badge:hover .delete-btn {
            opacity: 1;
        }

        .instance-badge .delete-btn:hover {
            background: #c0392b;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            background: #ecf0f1;
            color: #2c3e50;
        }

        table tbody tr {
            transition: background-color 0.2s;
        }

        table tbody tr:hover {
            background-color: #f8f9fa;
        }

        table tbody tr[style*="cursor: pointer"]:hover {
            background-color: #e3f2fd;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>📊 Executive Work Pulse</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="showAddJiraModal()">+ Add Jira Instance</button>
                <button class="btn btn-primary" onclick="refreshDashboard()">🔄 Refresh</button>
            </div>
        </header>
        
        <div id="jira-instances" class="jira-instances"></div>

        <div id="alert-container"></div>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Throughput</div>
                <div class="metric-value" id="throughput-value">-</div>
                <div class="metric-secondary" id="throughput-secondary">Created / Closed</div>
                <div class="metric-delta" id="throughput-delta"></div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">Lead Time</div>
                <div class="metric-value" id="leadtime-p50">-</div>
                <div class="metric-secondary" id="leadtime-p90">P90: - days</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">SLA Risk</div>
                <div class="metric-value" id="sla-risk">-</div>
                <div class="metric-secondary">Items at risk</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">Work in Progress</div>
                <div class="metric-value" id="wip-total">-</div>
                <div class="metric-secondary" id="wip-details">No assignee: - | Stuck: -</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">Quality</div>
                <div class="metric-value" id="quality-value">-</div>
                <div class="metric-secondary">Reopen rate</div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">Projects</div>
            <table id="projects-table">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th>Name</th>
                        <th>Instance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="projects-tbody">
                    <tr>
                        <td colspan="4" class="loading">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Project Detail Modal -->
        <div id="project-detail-modal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <h2 id="project-detail-title" style="margin-bottom: 20px;">Project Detail</h2>

                <div id="project-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div class="metric-card" style="padding: 15px;">
                        <div class="metric-label">Total Issues</div>
                        <div class="metric-value" id="project-total" style="font-size: 24px;">-</div>
                    </div>
                    <div class="metric-card" style="padding: 15px;">
                        <div class="metric-label">Open</div>
                        <div class="metric-value" id="project-open" style="font-size: 24px;">-</div>
                    </div>
                    <div class="metric-card" style="padding: 15px;">
                        <div class="metric-label">Closed</div>
                        <div class="metric-value" id="project-closed" style="font-size: 24px;">-</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px;">Issues</h3>
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>Summary</th>
                                <th>Status</th>
                                <th>Assignee</th>
                            </tr>
                        </thead>
                        <tbody id="project-issues-tbody">
                            <tr>
                                <td colspan="4" class="loading">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeProjectDetailModal()">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Jira Instance Modal -->
    <div id="add-jira-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Add Jira Instance</h2>
            <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="jira-display-name" placeholder="My Company Jira">
            </div>
            <div class="form-group">
                <label>Base URL</label>
                <input type="text" id="jira-base-url" placeholder="https://company.atlassian.net">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="jira-email" placeholder="your-email@company.com">
            </div>
            <div class="form-group">
                <label>API Token</label>
                <input type="password" id="jira-api-token" placeholder="Your Jira API token">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="closeAddJiraModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addJiraInstance()">Add & Test</button>
            </div>
        </div>
    </div>
    
    <script>
        const TENANT_ID = 'demo';
        let currentInstanceId = null;

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        async function loadJiraInstances() {
            try {
                const response = await fetch('/v1/pulse/jira/instances', {
                    headers: {'X-Tenant-Id': TENANT_ID}
                });
                const data = await response.json();

                const container = document.getElementById('jira-instances');

                if (data.instances.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No Jira instances connected. Click "+ Add Jira Instance" to get started.</div>';
                    return;
                }

                container.innerHTML = data.instances.map(inst => `
                    <div class="instance-badge ${currentInstanceId === inst.id ? 'active' : ''}"
                         onclick="selectInstance('${inst.id}')">
                        <span>${inst.display_name}</span>
                        <button class="delete-btn" onclick="deleteInstance(event, '${inst.id}', '${inst.display_name}')">✕</button>
                    </div>
                `).join('');

                if (data.instances.length > 0 && !currentInstanceId) {
                    currentInstanceId = data.instances[0].id;
                    loadDashboard();
                }
            } catch (error) {
                console.error('Failed to load Jira instances:', error);
                showAlert('Failed to load Jira instances: ' + error.message, 'warning');
            }
        }

        async function deleteInstance(event, instanceId, displayName) {
            event.stopPropagation(); // Prevent selecting the instance

            if (!confirm(`Are you sure you want to delete "${displayName}"?\n\nThis will remove the instance but keep the data.`)) {
                return;
            }

            try {
                const response = await fetch(`/v1/pulse/jira/instances/${instanceId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert(`✅ Jira instance "${displayName}" deleted successfully!`, 'success');

                    // If deleted instance was selected, clear selection
                    if (currentInstanceId === instanceId) {
                        currentInstanceId = null;
                    }

                    // Reload instances and dashboard
                    loadJiraInstances();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    showAlert('❌ Failed to delete instance: ' + error.detail, 'warning');
                }
            } catch (error) {
                showAlert('❌ Failed to delete instance: ' + error.message, 'warning');
            }
        }
        
        async function loadDashboard() {
            try {
                // Load projects from Jira directly (including archived)
                const projectsResponse = await fetch('/v1/pulse/projects?include_archived=true', {
                    headers: {'X-Tenant-Id': TENANT_ID}
                });
                const projectsData = await projectsResponse.json();

                console.log('Projects data:', projectsData); // Debug

                // Update projects table
                const tbody = document.getElementById('projects-tbody');
                if (projectsData.projects.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="loading">No projects found. Add a Jira instance first.</td></tr>';
                } else {
                    tbody.innerHTML = projectsData.projects.map(proj => {
                        const archivedBadge = proj.archived ? '<span class="badge" style="background: #e74c3c; color: white; margin-left: 8px;">ARCHIVED</span>' : '';
                        return `
                            <tr style="cursor: pointer; ${proj.archived ? 'opacity: 0.6;' : ''}" onclick="showProjectDetail('${proj.key}')">
                                <td><strong>${proj.key}</strong>${archivedBadge}</td>
                                <td>${proj.name}</td>
                                <td>${proj.instance_name}</td>
                                <td><button class="btn btn-primary" onclick="event.stopPropagation(); showProjectDetail('${proj.key}')">${proj.archived ? 'Try View' : 'View'}</button></td>
                            </tr>
                        `;
                    }).join('');
                }

                // Load dashboard metrics (from work_items if available)
                try {
                    const dashResponse = await fetch('/v1/pulse/dashboard', {
                        headers: {'X-Tenant-Id': TENANT_ID}
                    });
                    const data = await dashResponse.json();

                    // Update metrics
                    document.getElementById('throughput-value').textContent =
                        `${data.throughput.created} / ${data.throughput.closed}`;
                    document.getElementById('leadtime-p50').textContent =
                        `${data.leadTime.p50Days}d`;
                    document.getElementById('leadtime-p90').textContent =
                        `P90: ${data.leadTime.p90Days} days`;
                    document.getElementById('sla-risk').textContent = data.slaRisk.count;
                    document.getElementById('wip-total').textContent = data.wip.total;
                    document.getElementById('wip-details').textContent =
                        `No assignee: ${data.wip.noAssignee} | Stuck: ${data.wip.stuck}`;
                    document.getElementById('quality-value').textContent =
                        `${(data.quality.reopenRate * 100).toFixed(1)}%`;
                } catch (error) {
                    console.log('Dashboard metrics not available yet (no work items)');
                }
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                showAlert('Failed to load dashboard: ' + error.message, 'warning');
            }
        }

        async function showProjectDetail(projectKey) {
            try {
                // Show modal
                document.getElementById('project-detail-modal').style.display = 'flex';
                document.getElementById('project-detail-title').textContent = `Project: ${projectKey}`;

                // Show loading
                document.getElementById('project-issues-tbody').innerHTML =
                    '<tr><td colspan="4" class="loading">Loading...</td></tr>';

                // Fetch project detail
                const response = await fetch(`/v1/pulse/projects/${projectKey}`, {
                    headers: {'X-Tenant-Id': TENANT_ID}
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.detail || 'Failed to load project detail';

                    // Show error in modal
                    document.getElementById('project-issues-tbody').innerHTML =
                        `<tr><td colspan="4" style="color: #e74c3c; padding: 20px; text-align: center;">
                            <strong>❌ Error:</strong><br>${errorMsg}
                            ${response.status === 410 ? '<br><br>💡 This project may be archived or deleted. Try unarchiving it in Jira.' : ''}
                        </td></tr>`;

                    document.getElementById('project-total').textContent = '-';
                    document.getElementById('project-open').textContent = '-';
                    document.getElementById('project-closed').textContent = '-';
                    return;
                }

                const data = await response.json();

                // Normalize payload to avoid UI errors on missing fields
                const issues = Array.isArray(data.issues) ? data.issues : [];
                const total = Number.isFinite(data.total_issues) ? data.total_issues : issues.length;
                const openCount = Number.isFinite(data.open_issues)
                    ? data.open_issues
                    : issues.filter(i => (i.fields ? (i.fields.status?.name || i.status) : i.status) && !['Done','Closed'].includes(i.fields ? (i.fields.status?.name || i.status) : i.status)).length;
                const closedCount = Number.isFinite(data.closed_issues) ? data.closed_issues : (total - openCount);

                // Update stats
                document.getElementById('project-total').textContent = total;
                document.getElementById('project-open').textContent = openCount;
                document.getElementById('project-closed').textContent = closedCount;

                // Update issues table
                const tbody = document.getElementById('project-issues-tbody');
                if (issues.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="loading">No issues found</td></tr>';
                } else {
                    tbody.innerHTML = issues.map(issue => `
                        <tr>
                            <td><strong>${issue.key}</strong></td>
                            <td>${issue.summary}</td>
                            <td><span class="badge">${issue.status || (issue.fields?.status?.name || '-')}</span></td>
                            <td>${issue.assignee || (issue.fields?.assignee?.displayName || 'Unassigned')}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load project detail:', error);
                showAlert('Failed to load project detail: ' + error.message, 'warning');
                closeProjectDetailModal();
            }
        }

        function closeProjectDetailModal() {
            document.getElementById('project-detail-modal').style.display = 'none';
        }
        
        function selectInstance(instanceId) {
            currentInstanceId = instanceId;
            loadJiraInstances();
            loadDashboard();
        }
        
        function refreshDashboard() {
            loadDashboard();
        }
        
        function showAddJiraModal() {
            document.getElementById('add-jira-modal').classList.add('active');
        }
        
        function closeAddJiraModal() {
            document.getElementById('add-jira-modal').classList.remove('active');
        }
        
        async function addJiraInstance() {
            const displayName = document.getElementById('jira-display-name').value;
            const baseUrl = document.getElementById('jira-base-url').value;
            const email = document.getElementById('jira-email').value;
            const apiToken = document.getElementById('jira-api-token').value;

            if (!displayName || !baseUrl || !email || !apiToken) {
                alert('Please fill all fields');
                return;
            }

            // Show loading message
            const addButton = document.querySelector('.modal-content .btn-primary');
            const originalText = addButton.textContent;
            addButton.textContent = 'Testing connection...';
            addButton.disabled = true;

            try {
                const response = await fetch('/v1/pulse/jira/instances', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-Id': TENANT_ID
                    },
                    body: JSON.stringify({
                        display_name: displayName,
                        base_url: baseUrl,
                        email: email,
                        api_token: apiToken
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    closeAddJiraModal();

                    // Clear form
                    document.getElementById('jira-display-name').value = '';
                    document.getElementById('jira-base-url').value = '';
                    document.getElementById('jira-email').value = '';
                    document.getElementById('jira-api-token').value = '';

                    // Show success message
                    showAlert(
                        '✅ Jira instance added! Loading data in background... Dashboard will update shortly.',
                        'success'
                    );

                    // Reload instances immediately
                    loadJiraInstances();

                    // Reload dashboard every 3 seconds for 15 seconds
                    let reloadCount = 0;
                    const reloadInterval = setInterval(() => {
                        loadDashboard();
                        reloadCount++;
                        if (reloadCount >= 5) {
                            clearInterval(reloadInterval);
                            showAlert('✅ Data loaded successfully!', 'success');
                        }
                    }, 3000);
                } else {
                    const error = await response.json();
                    showAlert('❌ ' + error.detail, 'warning');
                }
            } catch (error) {
                showAlert('❌ Failed to add Jira instance: ' + error.message, 'warning');
            } finally {
                addButton.textContent = originalText;
                addButton.disabled = false;
            }
        }
        
        // Load on page load
        loadJiraInstances();
    </script>
</body>
</html>
